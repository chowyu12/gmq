services:
  # DragonflyDB - 高性能 Redis 兼容存储
  dragonfly:
    image: 'docker.dragonflydb.io/dragonflydb/dragonfly'
    container_name: gmq-dragonfly
    ports:
      - "6379:6379"
    ulimits:
      memlock: -1
    networks:
      - gmq-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Storage Service - 存储服务 (负责对接 Dragonfly)
  storage:
    build:
      context: .
      dockerfile: Dockerfile
      target: storage
    container_name: gmq-storage
    hostname: storage
    command: ["/app/gmq-storage-service", "-addr", ":50052", "-redis-addr", "dragonfly:6379"]
    ports:
      - "50052:50052"
    networks:
      - gmq-network
    depends_on:
      dragonfly:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50052"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Broker Service - 连接 + 分发服务
  broker:
    build:
      context: .
      dockerfile: Dockerfile
      target: broker
    hostname: broker
    command:
      - /app/gmq-broker-service
      - -addr
      - ":50051"
      - -storage
      - storage:50052
      - -partitions
      - "10"
    ports:
      - "50051:50051"
    networks:
      - gmq-network
    depends_on:
      storage:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  gmq-network:
    driver: bridge
