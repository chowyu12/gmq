# GMQ (Go Message Queue)

GMQ æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€ç”Ÿäº§çº§çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŸºäº gRPC åŒå‘ Stream åè®®å®ç°ã€‚å®ƒé‡‡ç”¨å­˜å‚¨ä¸åˆ†å‘åˆ†ç¦»çš„æ¶æ„ï¼Œæ”¯æŒ Topicã€Partitionã€æ¶ˆè´¹ç»„è´Ÿè½½å‡è¡¡ä»¥åŠ QoS 0/1 æ¶ˆæ¯è´¨é‡ä¿è¯ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **é«˜æ€§èƒ½é€šä¿¡**: åŸºäº gRPC Bidirectional Streamï¼Œç»´æŒå®¢æˆ·ç«¯ä¸ Broker é—´çš„é•¿è¿æ¥ã€‚
- **ç°ä»£åŒ–æ¶æ„**:
  - **Broker Service**: é›†æˆè¿æ¥ç½‘å…³ä¸åˆ†å‘é€»è¾‘ï¼Œå®Œå…¨æ— çŠ¶æ€ï¼Œæ”¯æŒæ— é™æ°´å¹³æ‰©å±•ã€‚
  - **Storage Service**: ç‹¬ç«‹å­˜å‚¨å±‚ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä¸çŠ¶æ€ï¼ˆæ¶ˆè´¹è€…/æ¶ˆè´¹ç»„ï¼‰çš„å¼ºä¸€è‡´æ€§ç®¡ç†ã€‚
- **å¼ºä¸€è‡´æ€§çŠ¶æ€**: å­˜å‚¨å±‚å†…ç½® SQLite (çº¯ Go å®ç°)ï¼Œåˆ©ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯æ¶ˆè´¹ç»„å…ƒæ•°æ®çš„å®Œæ•´æ€§ã€‚
- **çµæ´»çš„è·¯ç”±**: æ”¯æŒ Partition Key (Hash)ã€æŒ‡å®š Partition ID ä»¥åŠéšæœºåˆ†é…ã€‚
- **è‡ªåŠ¨ç®¡ç†**: æ”¯æŒ Topic è‡ªåŠ¨åˆ›å»ºï¼ˆé»˜è®¤ 3 åˆ†åŒºï¼‰ï¼Œä¹Ÿæ”¯æŒæ‰‹åŠ¨æ¥å£åˆ›å»ºã€‚
- **å‚æ•°åŒ–è¿æ¥**: å®¢æˆ·ç«¯å¯è‡ªå®šä¹‰ ClientID å’Œæ¶ˆæ¯æ‹‰å–é—´éš” (Pull Interval)ã€‚
- **å¯é æ€§ä¿è¯**: æ”¯æŒ QoS 1 (è‡³å°‘ä¸€æ¬¡) ç¡®è®¤æœºåˆ¶ï¼Œæ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–å­˜å‚¨ã€‚
- **å®¹å™¨åŒ–æ”¯æŒ**: é¢„ç½® Docker Compose éƒ¨ç½²é…ç½®ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Producers     â”‚      â”‚           Consumers              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                â”‚
         â”‚ gRPC Stream                    â”‚ gRPC Stream
         â†“                                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                     â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Broker-1     â”‚   â”‚    Broker-2     â”‚   â”‚    Broker-N     â”‚
â”‚ (Stateless)     â”‚   â”‚ (Stateless)     â”‚   â”‚ (Stateless)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ gRPC
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Storage Service (Stateful)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - Message Logs (File System)                             â”‚
â”‚  - Consumer/Group States (SQLite Persistent)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
gmq/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ broker-service/       # æ¥å…¥ä¸åˆ†å‘æœåŠ¡ (æ— çŠ¶æ€)
â”‚   â””â”€â”€ storage-service/      # å­˜å‚¨æœåŠ¡ (æœ‰çŠ¶æ€)
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ storage/              # å­˜å‚¨å¼•æ“ä¸ SQLite çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ config/               # é…ç½®åŠ è½½
â”œâ”€â”€ pkg/client/               # å®¢æˆ·ç«¯ SDK
â”œâ”€â”€ proto/                    # gRPC åè®®å®šä¹‰ (Broker/Storage)
â”œâ”€â”€ examples/                 # ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€æ¶ˆè´¹ç»„ç¤ºä¾‹
â”œâ”€â”€ docker-compose.yml        # ä¸€é”®éƒ¨ç½²ç¼–æ’
â””â”€â”€ Makefile                  # è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ 1ï¼šDocker Compose éƒ¨ç½² (æ¨è)

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ (1 Storage + 2 Broker)
make docker

# æŸ¥çœ‹æ—¥å¿—
make docker-logs
```

### æ–¹å¼ 2ï¼šæœ¬åœ°æ‰‹åŠ¨ç¼–è¯‘å¯åŠ¨

```bash
# 1. æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
make build-dist

# 2. å¯åŠ¨å­˜å‚¨æœåŠ¡
make run-storage

# 3. å¯åŠ¨ Broker æœåŠ¡
make run-broker
```

## ğŸ’» å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹

### ç”Ÿäº§è€… (Producer)

```go
client, _ := client.NewClient(&client.ClientConfig{
    ServerAddr: "localhost:50051", // è¿æ¥ Broker ç«¯å£
})
defer client.Close()

// å‘é€ä¸€æ¡ QoS 1 æ¶ˆæ¯
resp, _ := client.Publish(ctx, "orders", []byte("Order#1001"), 
    client.WithQoS(pb.QoS_QOS_AT_LEAST_ONCE),
    client.WithPartitionKey("user_id_123"))
```

### æ¶ˆè´¹è€… (Consumer)

```go
consumer, _ := client.NewClient(&client.ClientConfig{
    ServerAddr:    "localhost:50051",
    ConsumerGroup: "order-processors",
    MessageHandler: func(msg *pb.ConsumeMessage) error {
        fmt.Printf("æ”¶åˆ°è®¢å•: %s\n", string(msg.Payload))
        return nil
    },
})
consumer.Subscribe(ctx, "orders")
```

## ğŸ“Š è¿ç»´å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|-----|------|
| `make docker-scale` | æ‰©å±• Broker å®ä¾‹è‡³ 3 ä¸ª |
| `make docker-ps` | æŸ¥çœ‹å®¹å™¨è¿è¡ŒçŠ¶æ€ä¸å¥åº·æ£€æŸ¥ |
| `make clean` | æ¸…ç†æ„å»ºäº§ç‰©ä¸å­˜å‚¨æ•°æ® |
| `make proto-dist` | é‡æ–°ç”Ÿæˆ gRPC åè®®ä»£ç  |

## ğŸ“œ æ¶æ„æ¼”è¿›è¯´æ˜
å…³äºæœ¬é¡¹ç›®ä»å•æœºåˆ°åˆ†å¸ƒå¼ Broker åˆå¹¶çš„è¯¦ç»†æ¼”è¿›å†ç¨‹ï¼Œè¯·å‚è€ƒ [ARCHITECTURE-EVOLUTION.md](ARCHITECTURE-EVOLUTION.md)ã€‚

---
**License**: MIT | **Go Version**: 1.24+
