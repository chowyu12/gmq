syntax = "proto3";

package gmq;

option go_package = "github.com/chowyu12/gmq/proto;gmq";

// GMQ 消息队列服务
service GMQService {
  // 双向流：生产和消费消息
  rpc Stream(stream StreamMessage) returns (stream StreamMessage);

  // 管理接口：手动创建 Topic
  rpc CreateTopic(CreateTopicRequest) returns (CreateTopicResponse);
}

// 流消息封装
message StreamMessage {
  // 消息类型
  MessageType type = 1;
  
  // 具体消息内容（根据type选择对应字段）
  oneof payload {
    PublishRequest publish_req = 2;
    PublishResponse publish_resp = 3;
    SubscribeRequest subscribe_req = 4;
    SubscribeResponse subscribe_resp = 5;
    ConsumeMessage consume_msg = 6;
    AckRequest ack_req = 7;
    AckResponse ack_resp = 8;
    HeartbeatRequest heartbeat_req = 9;
    HeartbeatResponse heartbeat_resp = 10;
    ErrorResponse error_resp = 11;
    PullRequest pull_req = 12;
  }
}

// 消息类型
enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;
  // 发布消息请求
  MESSAGE_TYPE_PUBLISH_REQUEST = 1;
  // 发布消息响应
  MESSAGE_TYPE_PUBLISH_RESPONSE = 2;
  // 订阅请求
  MESSAGE_TYPE_SUBSCRIBE_REQUEST = 3;
  // 订阅响应
  MESSAGE_TYPE_SUBSCRIBE_RESPONSE = 4;
  // 消费消息推送
  MESSAGE_TYPE_CONSUME_MESSAGE = 5;
  // 消息确认请求
  MESSAGE_TYPE_ACK_REQUEST = 6;
  // 消息确认响应
  MESSAGE_TYPE_ACK_RESPONSE = 7;
  // 心跳请求
  MESSAGE_TYPE_HEARTBEAT_REQUEST = 8;
  // 心跳响应
  MESSAGE_TYPE_HEARTBEAT_RESPONSE = 9;
  // 错误响应
  MESSAGE_TYPE_ERROR_RESPONSE = 10;
  // 客户端主动拉取请求
  MESSAGE_TYPE_PULL_REQUEST = 11;
}

// QoS 级别
enum QoS {
  // 至多一次 (Fire and Forget)
  QOS_AT_MOST_ONCE = 0;
  // 至少一次 (Acknowledged)
  QOS_AT_LEAST_ONCE = 1;
  // 严格一次 (Exactly Once)
  QOS_EXACTLY_ONCE = 2;
}

// 发布消息请求 (支持批量)
message PublishRequest {
  // 请求ID
  string request_id = 1;
  // 消息列表
  repeated PublishItem items = 2;
}

message PublishItem {
  // Topic 名称
  string topic = 1;
  // 分区键（用于确定分区）
  string partition_key = 2;
  // 指定分区ID（可选，优先级高于partition_key）
  int32 partition_id = 3;
  // 消息体
  bytes payload = 4;
  // 消息属性
  map<string, string> properties = 5;
  // QoS 级别
  QoS qos = 6;
  // 生产端幂等支持
  string producer_id = 7;
  int64 sequence_number = 8;
}

// 发布消息响应 (支持批量)
message PublishResponse {
  // 请求ID
  string request_id = 1;
  // 结果列表
  repeated PublishResult results = 2;
}

message PublishResult {
  // 是否成功
  bool success = 1;
  // 消息ID
  string message_id = 2;
  // Topic 名称
  string topic = 3;
  // 实际分区ID
  int32 partition_id = 4;
  // 错误信息
  string error_message = 5;
}

// 订阅请求
message SubscribeRequest {
  // 请求ID
  string request_id = 1;
  // Topic 名称
  string topic = 2;
  // 消费组名称
  string consumer_group = 3;
  // 消费者ID
  string consumer_id = 4;
  // QoS 级别
  QoS qos = 5;
  // 订阅的分区列表（为空则订阅所有分区）
  repeated int32 partitions = 6;
  // 拉取间隔（毫秒），可选
  int32 pull_interval_ms = 7;
  // 客户端标识，可选
  string client_id = 8;
}

// 手动创建 Topic 请求
message CreateTopicRequest {
  string topic = 1;
  int32 partitions = 2;
  int64 ttl_seconds = 3;
}

message CreateTopicResponse {
  bool success = 1;
  string error_message = 2;
}

// 订阅响应
message SubscribeResponse {
  // 请求ID
  string request_id = 1;
  // 是否成功
  bool success = 2;
  // 分配的分区列表
  repeated int32 assigned_partitions = 3;
  // 错误信息
  string error_message = 4;
}

// 消费消息 (支持批量推送)
message ConsumeMessage {
  repeated MessageItem items = 1;
}

message MessageItem {
  // 消息ID
  string message_id = 1;
  // Topic 名称
  string topic = 2;
  // 分区ID
  int32 partition_id = 3;
  // 偏移量
  int64 offset = 4;
  // 消息体
  bytes payload = 5;
  // 消息属性
  map<string, string> properties = 6;
  // 时间戳
  int64 timestamp = 7;
  // QoS 级别
  QoS qos = 8;
  // 分区路由 Key
  string key = 9;
}

// 消息确认请求 (支持批量确认)
message AckRequest {
  // 请求ID
  string request_id = 1;
  // 消费组
  string consumer_group = 2;
  // 消费者ID
  string consumer_id = 3;
  // 确认项列表
  repeated AckItem items = 4;
}

message AckItem {
  string topic = 1;
  int32 partition_id = 2;
  string message_id = 3;
  int64 offset = 4;
}

// 消息确认响应
message AckResponse {
  // 请求ID
  string request_id = 1;
  // 是否成功
  bool success = 2;
  // 错误信息
  string error_message = 3;
}

// 心跳请求
message HeartbeatRequest {
  // 消费者ID
  string consumer_id = 1;
  // 消费组
  string consumer_group = 2;
}

// 心跳响应
message HeartbeatResponse {
  // 是否成功
  bool success = 1;
}

// 错误响应
message ErrorResponse {
  // 错误码
  int32 code = 1;
  // 错误信息
  string message = 2;
}

// 客户端主动拉取消息请求
message PullRequest {
  string consumer_id = 1;
  string consumer_group = 2;
  string topic = 3;
  int32 limit = 4;
}
